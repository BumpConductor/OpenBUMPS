<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="shared-styles.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">

<dom-module id="obump-addbump">
  <template>
    <style include="shared-styles">
      :host {
        display: block;

        padding: 10px;
      }
    </style>

    <div class="card">
      <h1>Add BUMPS</h1>
    </div>
    
    <div>
      <paper-input label="Enter a title here" value={{title}}></paper-input>
      <paper-textarea rows="10" label="Enter a description here" value={{description}}></paper-textarea>
      <input id="upper" type="file" accept=image/*/>
      <progress value="0" max="100" id="uploadprogress"></progress><br>
      <paper-button on-tap="updateVar">Submit Bump</paper-button>
    </div>

  </template>

  <script>
    Polymer({
      is: 'obump-addbump',
      properties: {
        title: String,
        description: String,
        photourl: {
          type: String,
          value: "test"
        }
      },

      updateVar: function () {
        bumpData = {
          user: firebase.auth().currentUser.uid,
          title: this.title,
          description: this.description,
          pictureurl: this.photourl,
          time: firebase.database.ServerValue.TIMESTAMP
        };
        var newBumpKey = firebase.database().ref().child('bumps').push().key;
        var updates = {};
        updates['/bumps/' + newBumpKey] = bumpData;
        firebase.database().ref().update(updates);
        this.title = "";
        this.description = "";
      },

      uploadFile: function () {

      },

      ready: function () {
        // get refs to upload buuton and progress bar
        var fileButton = Polymer.dom(this.root).querySelector('#upper');
        var progressBar = Polymer.dom(this.root).querySelector('#uploadprogress');
        
        fileButton.addEventListener("change", function (event) {
          // get file
          var file = event.target.files[0];
          // create storage reference
          var storage = firebase.storage();
          this.photourl = "bump_images/" + file.name;
          var storageRef = storage.ref("bump_images/" + file.name);
          // upload file"bump_images/" + 
          var uploadTask = storageRef.put(file);
          // do progress
          uploadTask.on("state_changed", 
            function progress(snapshot) {
              var percentage = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
              progressBar.value = percentage;
            },
            function error(err) {
              console.log(err);
            },
            function complete() {
              console.log("completed file upload");
            }
          );
        }.bind(this));
      }
    });
  </script>
</dom-module>
